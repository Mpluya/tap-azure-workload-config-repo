---
apiVersion: v1
kind: Secret
metadata:
  name: activate-overlay-secret
  namespace: dev2
stringData:
  custom-package-overlay.yaml: |
    #@ load("@ytt:overlay", "overlay")
    #@ load("@ytt:data", "data")

    #@ kd = overlay.subset({"apiVersion":"apps/v1", "kind": "Deployment"})
    #@ ks = overlay.subset({"apiVersion":"v1", "kind": "Service"})
    #@ ki = overlay.subset({"apiVersion":"networking.k8s.io/v1", "kind": "Ingress"})
    #@ na = overlay.subset({"metadata":{"name":"greeter-source-package-green"}})

    #@overlay/match by=overlay.and_op(kd, na)
    ---
    metadata:
      #@overlay/replace
      name: greeter-source-package

    #@overlay/match by=overlay.and_op(ks, na)
    ---
    metadata:
      #@overlay/replace
      name: greeter-source-package

    #@overlay/match by=overlay.and_op(ki, na)
    ---
    metadata:
      #@overlay/replace
      name: greeter-source-package

    ---
    apiVersion: projectcontour.io/v1
    kind: HTTPProxy
    metadata:
      name: blue
      namespace: dev2
    spec:
      virtualhost:
        fqdn: greeter-source.run.cssa.tapsme.org
        tls:
          secretName: greeter-source
      routes:
        - conditions:
          - prefix: /
          services:
            - name: greeter-source-package #! note the name is changed back
              port: 8080
              weight: 100